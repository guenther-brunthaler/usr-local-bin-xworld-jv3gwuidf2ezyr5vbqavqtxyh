#! /bin/sh
# Rename patches to the names taken from markers within the patch headers (if
# present). Nummeric prefixes are kept. This is especially useful for patches
# generated by "git format-patch".
#
# Version 2018.257
# Copyright (c) 2018 Guenther Brunthaler. All rights reserved.
#
# This source file is free software.
# Distribution is permitted under the terms of the GPLv3.

marker=original-patch-name:

set -e
trap 'test $? = 0 || echo "\"$0\" failed!" >& 2' 0

EMUL=
while getopts n opt
do
	case $opt in
		n) EMUL=echo;;
		*) false || exit
	esac
done
shift `expr $OPTIND - 1 || :`

original_name() {
	sed '
		/^+++/,$ d
		s/^'"$marker"'[[:space:]]*\(.*[^[:space:]]\).*/\1/; t 1
		d
		:1
		q
	' "$1"
}

for f
do
	oname=`original_name "$f"` && test "$oname" || continue
	if pfx=`expr x"$f" : x'\([0-9]\{1,\}-\)'`
	then
		sfx=${f#"$pfx"}
		oname=${f%"$sfx"}$oname
	fi
	test "$f" = "$oname" && continue
	$EMUL mv -- "$f" "$oname"
done
