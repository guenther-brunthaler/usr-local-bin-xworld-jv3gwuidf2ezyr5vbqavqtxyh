#! /bin/sh
# Apply a patch generated by diff-line-by-line
# to a list of files specified as arguments.
# The diff should specify symbols which will match
# at any position except immediately before or after isalpha().
# That means they will match also immediately before or after "_"!


fail() {
	RC=$?
	test -n "$1" && RC=$1
	test $RC = 0 && { false; RC=$?; }
	test -z "$UNWIND" && exit $RC
	return $RC
}


die() {
	RC=$?
	echo "ERROR: $*" >& 2
	fail $RC
}


cmd_failure() {
	die "Command >>>$1<<< failed with return code $2!"
}


run() {
	"$@" ||	cmd_failure "$*" $?
}


system() {
	REPLY=`UNWIND= run "$@"` || fail
}


pr_chksum() {
	run md5sum -b "$1" | run cut -c-32
}


chksum() {
	system pr_chksum "$1"
}


while
	IFS= read -r FROM0 \
	&& IFS= read -r TO0
do
	FROM=${FROM0#-}; TO=${TO0#+}
	run test x"$FROM" != x"$FROM0"
	run test x"$TO" != x"$TO0"
	for F
	do
		T=${F}_rpl.tmp
		chksum "$F"; OC=$REPLY
		run cat "$F" | run perl -e '
			$from= quotemeta $ARGV[0];
			$to= quotemeta $ARGV[1];
			while (defined($_= <STDIN>)) {
				s{
					(?: ^ | (?<! [:alnum:] ) )
					$from
					(?= [^[:alnum:]] | $ )
				}{$to}gxo;
				print;
			}
		' -- "$FROM" "$TO"> "$T"
		chksum "$T"
		test x"$REPLY" != x"$OC" && {
			#echo "Replacing changes in '$F'..." >& 2
			run cat "$T" > "$F"
		}
		run rm "$T"
	done
done
